<views:WindowBase x:Class="GitWrite.Views.CommitWindow"
   x:Name="PageRoot"
   xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
   xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
   xmlns:i="clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity"
   xmlns:cmd="clr-namespace:GalaSoft.MvvmLight.Command;assembly=GalaSoft.MvvmLight.Extras.WPF45"
   xmlns:views="clr-namespace:GitWrite.Views"
   xmlns:c="clr-namespace:GitWrite.Views.Controls"
   xmlns:converters="clr-namespace:GitWrite.Views.Converters"
   xmlns:behaviors="clr-namespace:GitWrite.Behaviors"
   AllowsTransparency="True"
   Background="Transparent"
   Title="{Binding Title}"
   Width="1080"
   Height="{x:Static views:WindowValues.NonExpandedHeight}"
   ResizeMode="NoResize"
   WindowStyle="None"
   FocusManager.FocusedElement="{Binding ElementName=CommitText}"
   CommandManager.PreviewCanExecute="CommitWindow_OnPreviewCanExecute"
   DataContext="{Binding CommitViewModel, Source={StaticResource ViewModelLocator}}">

   <Window.Resources>
      <ResourceDictionary>
         <ResourceDictionary.MergedDictionaries>
            <ResourceDictionary Source="..\Styles\TextBoxStyle.xaml" />
            <ResourceDictionary Source="..\Styles\ButtonStyle.xaml" />
            <ResourceDictionary Source="CommitWindowResources.xaml" />
            <ResourceDictionary>
               <Storyboard x:Key="ExitStoryboard">
                  <DoubleAnimation Storyboard.TargetName="GreenGrid"
                     Storyboard.TargetProperty="Width"
                     From="0"
                     To="1080"
                     Duration="0:0:1">
                  </DoubleAnimation>
                  <DoubleAnimation Storyboard.TargetName="GreenPie"
                     Storyboard.TargetProperty="Angle"
                     From="0"
                     To="360"
                     Duration="0:0:0.8">
                  </DoubleAnimation>
                  <DoubleAnimation Storyboard.TargetName="ExitGlyph"
                     Storyboard.TargetProperty="FontSize"
                     From="0"
                     To="44"
                     BeginTime="0:0:1"
                     Duration="0:0:0.3">
                     <DoubleAnimation.EasingFunction>
                        <BackEase EasingMode="EaseOut" />
                     </DoubleAnimation.EasingFunction>
                  </DoubleAnimation>
               </Storyboard>
               <converters:LeftClipConverter x:Key="LeftClipConverter" />
            </ResourceDictionary>
         </ResourceDictionary.MergedDictionaries>
      </ResourceDictionary>
   </Window.Resources>

   <i:Interaction.Behaviors>
      <behaviors:CommitCaretPositionBehavior />
   </i:Interaction.Behaviors>

   <i:Interaction.Triggers>
      <i:EventTrigger EventName="Loaded">
         <cmd:EventToCommand Command="{Binding LoadCommand, Mode=OneTime}" />
      </i:EventTrigger>
   </i:Interaction.Triggers>

   <Grid x:Name="MainGrid">
      <VisualStateManager.VisualStateGroups>
         <VisualStateGroup x:Name="ExpansionStates">
            <VisualState x:Name="Collapsed">
               <Storyboard>
                  <DoubleAnimation Storyboard.TargetName="PageRoot"
                     Storyboard.TargetProperty="Height"
                     To="100"
                     Duration="0:0:0.2">
                     <DoubleAnimation.EasingFunction>
                        <CircleEase EasingMode="EaseOut" />
                     </DoubleAnimation.EasingFunction>   
                  </DoubleAnimation>
                  <DoubleAnimation Storyboard.TargetName="SecondaryBorder"
                     Storyboard.TargetProperty="Opacity"
                     From="1"
                     To="0"
                     Duration="0:0:0.1"
                     BeginTime="0:0:0.18" />
               </Storyboard>
            </VisualState>

            <VisualState x:Name="Expanded">
               <Storyboard>
                  <DoubleAnimation Storyboard.TargetName="SecondaryBorder"
                     Storyboard.TargetProperty="Opacity"
                     From="0"
                     To="1"
                     Duration="0:0:0.1" />
                  <DoubleAnimation Storyboard.TargetName="PageRoot"
                     Storyboard.TargetProperty="Height"
                     To="400"
                     Duration="0:0:1">
                     <DoubleAnimation.EasingFunction>
                        <CircleEase EasingMode="EaseOut" />
                     </DoubleAnimation.EasingFunction>
                  </DoubleAnimation>
               </Storyboard>
            </VisualState>
         </VisualStateGroup>
      </VisualStateManager.VisualStateGroups>

      <Grid.RowDefinitions>
         <RowDefinition Height="100" />
         <RowDefinition Height="*" />
      </Grid.RowDefinitions>

      <Grid>
         <Grid.ColumnDefinitions>
            <ColumnDefinition />
            <ColumnDefinition Width="100" />
         </Grid.ColumnDefinitions>

         <Grid Grid.Column="0"
            Grid.ColumnSpan="2"
            Height="80"
            VerticalAlignment="Center">
            <Grid.Effect>
               <DropShadowEffect BlurRadius="16"
                  ShadowDepth="1"
                  Direction="270" />
            </Grid.Effect>

            <Border CornerRadius="14"
               Margin="12"
               Padding="12"
               BorderThickness="2"
               BorderBrush="{DynamicResource WindowBorderColor}"
               Background="{DynamicResource WindowBackgroundColor}"
               Clip="M 0,0 H 988 A 44,44 45 0 0 988,56 H -988">

               <TextBox x:Name="CommitText"
                  Foreground="{DynamicResource TextColor}"
                  FontFamily="Consolas"
                  FontSize="24"
                  MaxLength="72"
                  HorizontalAlignment="Stretch"
                  Text="{Binding ShortMessage, UpdateSourceTrigger=PropertyChanged}">
                  <TextBox.Clip>
                     <MultiBinding Converter="{StaticResource LeftClipConverter}">
                        <Binding Path="ActualWidth" ElementName="GreenGrid" />
                        <Binding Path="ActualWidth" ElementName="CommitText" />
                     </MultiBinding>
                  </TextBox.Clip>
                  <i:Interaction.Triggers>
                     <i:EventTrigger EventName="GotFocus">
                        <cmd:EventToCommand Command="{Binding PrimaryMessageGotFocusCommand, Mode=OneTime}"
                           MustToggleIsEnabledValue="True" />
                     </i:EventTrigger>
                  </i:Interaction.Triggers>
               </TextBox>
            </Border>

            <Border x:Name="GreenGrid"
               Width="0"
               Margin="12"
               Padding="12"
               HorizontalAlignment="Left"
               Background="{Binding ExitReason, Converter={StaticResource ExitReasonToBackgroundConverter}}">
               <Border.Effect>
                  <BlurEffect Radius="15" KernelType="Gaussian" />
               </Border.Effect>

               <TextBox Foreground="{DynamicResource TextColor}"
                  FontFamily="Consolas"
                  FontSize="24"
                  MaxLength="72"
                  IsTabStop="False"
                  Text="{Binding ShortMessage, UpdateSourceTrigger=PropertyChanged}" />
            </Border>
         </Grid>

         <c:RadialCounter Grid.Column="1"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Minimum="0"
            Maximum="72"
            FontSize="24"
            Value="{Binding Text.Length, ElementName=CommitText, Converter={StaticResource TextLengthInversionConverter}}">
            <c:RadialCounter.Effect>
               <DropShadowEffect BlurRadius="16"
                  ShadowDepth="1"
                  Direction="270" />
            </c:RadialCounter.Effect>
         </c:RadialCounter>

         <c:Pie x:Name="GreenPie"
            Fill="{Binding ExitReason, Converter={StaticResource ExitReasonToBackgroundConverter}}"
            Grid.Column="1"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Width="82"
            Height="82">
         </c:Pie>

         <TextBlock x:Name="ExitGlyph"
            Grid.Column="1"
            Foreground="#0F0"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            FontFamily="Segoe MDL2 Assets"
            FontSize="0.01"
            FontWeight="ExtraBold"
            Text="&#xE10B;">
            <TextBlock.Effect>
               <DropShadowEffect BlurRadius="8"
                  ShadowDepth="1"
                  Direction="270" />
            </TextBlock.Effect>
         </TextBlock>
      </Grid>

      <Grid x:Name="SecondaryBorder"
         Grid.Row="1"
         ZIndex="-1"
         Opacity="0">
         <Border CornerRadius="0,0,14,14"
            Margin="26,-24,26,12"
            BorderThickness="2"
            BorderBrush="{DynamicResource WindowSecondaryBorderColor}"
            Background="{DynamicResource WindowSecondaryBackgroundColor}">
            <Border.Effect>
               <DropShadowEffect BlurRadius="16"
                  ShadowDepth="1"
                  Direction="270" />
            </Border.Effect>

            <TextBox Foreground="{DynamicResource TextColor}"
               Padding="12"
               Background="Transparent"
               FontFamily="Consolas"
               FontSize="24"
               AcceptsReturn="True"
               TextWrapping="Wrap"
               Text="{Binding ExtraCommitText, UpdateSourceTrigger=PropertyChanged}">
               <i:Interaction.Triggers>
                  <i:EventTrigger EventName="GotFocus">
                     <cmd:EventToCommand Command="{Binding SecondaryNotesGotFocusCommand, Mode=OneTime}"
                        MustToggleIsEnabledValue="True" />
                  </i:EventTrigger>
               </i:Interaction.Triggers>
            </TextBox>
         </Border>
      </Grid>
   </Grid>
</views:WindowBase>
